<!doctype html>
<html>
<head>
  <title>SpoonOS Agentic Shopper</title>
  <style>
    :root { --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8; --text: #f1f5f9; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; height: 100vh; }
    
    .app-container { width: 100%; max-width: 1000px; display: flex; flex-direction: column; background: #111827; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    .header { padding: 20px; border-bottom: 1px solid #334155; background: #0f172a; display:flex; justify-content:space-between; align-items:center;}
    .header h1 { margin: 0; font-size: 1.2rem; color: var(--accent); }
    
    .chat-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    
    .message { max-width: 85%; padding: 15px; border-radius: 12px; line-height: 1.5; animation: fadeIn 0.3s; }
    .user { align-self: flex-end; background: var(--accent); color: #0f172a; border-bottom-right-radius: 2px; font-weight: 600; }
    .bot { align-self: flex-start; background: var(--card-bg); border: 1px solid #334155; border-bottom-left-radius: 2px; width: 100%; box-sizing: border-box; }
    
    .input-area { padding: 20px; background: #0f172a; border-top: 1px solid #334155; display: flex; gap: 10px; }
    input { flex: 1; padding: 12px 15px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 1rem; outline: none; }
    button { padding: 0 25px; background: var(--accent); color: #0f172a; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

    /* CARD GRID STYLES */
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top: 15px; }
    .card { background: #0f172a; border: 1px solid #334155; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s; }
    .card:hover { border-color: var(--accent); transform: translateY(-3px); }
    .image-container { height: 150px; background: white; display: flex; align-items: center; justify-content: center; padding: 10px; }
    .card img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .card .meta { padding: 12px; display: flex; flex-direction: column; flex: 1; gap: 6px; }
    .card .title { font-size: 0.9rem; font-weight: 600; height: 2.8em; overflow: hidden; }
    .card .price { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
    .card .store { font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px; }
    
    /* The Auto-Buy Button */
    .buy-btn { 
        margin-top: auto; width: 100%; padding: 10px; 
        background: linear-gradient(135deg, #3b82f6, #2563eb); 
        color: white; border: none; border-radius: 6px; 
        font-weight: bold; cursor: pointer; transition: opacity 0.2s;
    }
    .buy-btn:hover { opacity: 0.9; }
    .buy-btn:active { transform: scale(0.98); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
        <h1>üõçÔ∏è SpoonOS Agentic Shopper</h1>
        <span style="font-size:0.8rem; color:#64748b">Powered by Playwright</span>
    </div>
    
    <div class="chat-scroll" id="chatBox">
      <div class="message bot">
        System Online. I can find products and <b>Auto-Buy</b> them for you.<br><br>
        Try: "Find PS5 consoles"
      </div>
    </div>
    
    <div class="input-area">
      <input id="msg" type="text" placeholder="Search..." onkeypress="handleEnter(event)" autofocus />
      <button onclick="send()">Send</button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById('chatBox');
    const msgInput = document.getElementById('msg');

    function handleEnter(e) { if(e.key === 'Enter') send(); }

    function addMessage(html, role) {
      const div = document.createElement('div');
      div.className = message ${role};
      div.innerHTML = html; 
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 1. HANDLE SEARCH
    async function send() {
      const text = msgInput.value.trim();
      if (!text) return;
      addMessage(text, 'user');
      msgInput.value = '';

      const loading = document.createElement('div');
      loading.className = 'message bot';
      loading.textContent = 'finding the best deals that suits you';
      chatBox.appendChild(loading);

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        chatBox.removeChild(loading);
        
        if (data.error) addMessage("‚ö†Ô∏è Error: " + data.error, 'bot');
        else addMessage(data.response, 'bot'); // Renders HTML cards
      } catch (e) {
        chatBox.removeChild(loading);
        addMessage("‚ùå Network Error", 'bot');
      }
    }

    // 2. HANDLE AUTO-BUY TRIGGER
    async function triggerAutoBuy(encodedUrl) {
        console.log("Triggering Auto-Buy for:", encodedUrl);
        
        // Show status in chat
        addMessage(üöÄ <b>Initiating Auto-Buy Sequence...</b><br>Targeting URL... launching Agent Browser., 'bot');

        try {
            const res = await fetch('/execute_buy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: encodedUrl })
            });
            const data = await res.json();
            
            if (data.error) addMessage("‚ùå Buy Failed: " + data.error, 'bot');
            else addMessage("‚úÖ <b>Sequence Complete!</b> Item added to cart.", 'bot');
            
        } catch (e) {
            addMessage("‚ùå Connection Error during buy sequence.", 'bot');
        }
    }
  </script>
</body>
</html>
